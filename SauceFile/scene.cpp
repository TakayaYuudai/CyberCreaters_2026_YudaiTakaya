//================================================================================================================================================================
//
//モデル処理[objectX.cpp]
//Author : Yuudai Takaya
//
//================================================================================================================================================================

//================================================================================================================================================================
//ライブラリリンク
//================================================================================================================================================================
#include "scene.h"
#include "object.h"
#include "manager.h"
#include "field.h"
#include "player_3d.h"
#include "enemy_boss.h"
#include "missile.h"
#include "missile.h"
#include "sky.h"
#include "icon_circle.h"
#include "icon_life.h"
#include "icon_heat.h"
#include "a.h"
#include "title_guide.h"
#include "tutorial_player.h"
#include "title_player.h"
#include "game_player.h"
#include "control_guide.h"
#include "sound.h"

bool CScene::m_bPushFade  = false;
bool CScene::m_bWinResult = false;

//================================================================================================================================================================
//コンストラクタ（自分自身の登録）
//================================================================================================================================================================
CScene::CScene()
{

}

//================================================================================================================================================================
//デストラクタ
//================================================================================================================================================================
CScene::~CScene()
{

}

//================================================================================================================================================================
//初期設定
//================================================================================================================================================================
HRESULT CScene::Init()
{
	CManager::GetInstance()->GetSound()->StopSound();

	//フェードカウンターリセット
	m_nFadeCnt = NULL;
	//フェードモードリセット
	m_bPushFade = false;

	return S_OK;
}

//================================================================================================================================================================
//終了処理
//================================================================================================================================================================
void CScene::Uninit()
{
	CObject::ReleaseAll();
}

//================================================================================================================================================================
//更新処理
//================================================================================================================================================================
void CScene::Update()
{
	CInputKeyboard* pKeyboard = CManager::GetInstance()->GetKeyboard();
	CInputJoypad* pJoyPad = CManager::GetInstance()->GetPad();
	D3DXVECTOR2 pFpos = CManager::GetInstance()->GetFade()->GetFadePos();

	//フェードモード時にカウントスタート
	if (m_bPushFade){
		m_nFadeCnt++;
	}
}

//================================================================================================================================================================
//描画処理
//================================================================================================================================================================
void CScene::Draw()
{

}

//================================================================================================================================================================
//scene切り替え処理
//================================================================================================================================================================
void CScene::FadeTrigger() {
	D3DXVECTOR2 pFpos = CManager::GetInstance()->GetFade()->GetFadePos();
	if (pFpos.y <= 0.f - SCREEN_HEIGHT * 0.25f) {
		m_bPushFade = true;
	}
}

//********************************************タイトル管理クラス//********************************************

//================================================================================================================================================================
//コンストラクタ
//================================================================================================================================================================
CTitle::CTitle()
{

}

//================================================================================================================================================================
//デストラクタ
//================================================================================================================================================================
CTitle::~CTitle()
{

}

//================================================================================================================================================================
//初期設定
//================================================================================================================================================================
HRESULT CTitle::Init(){

	const float fLogoSize = 300.f;

	CScene::Init();
	CStart_Button::Create({640.f, 650.f},240,50.f);
	CPlayer_Title::Create();
	CTitle_Logo::Create({640.f - fLogoSize,360.f}, fLogoSize,100.f);
	CTitle_LogoRight::Create({ 640.f + fLogoSize,360.f }, fLogoSize, 100.f);

	CTitle_Gear::Create({ 640.f + fLogoSize * 0.4f, 360.f - 80.f}, 50.f, 50.f, true,true);
	CTitle_Gear::Create({ 640.f + fLogoSize * 0.4f - 30.f, 280.f - 80.f }, 50.f, 50.f, false,true);

	CTitle_Gear::Create({ 640.f - 100.f, 360.f + 180.f }, 50.f, 50.f, true,false);
	CTitle_Gear::Create({ 640.f - 100.f + 30.f, 280.f + 180.f }, 50.f, 50.f, false,false);

	CManager::GetInstance()->GetSound()->PlaySoundA(CSound::TITLE_BGM);

	return S_OK;
}

//================================================================================================================================================================
//終了処理
//================================================================================================================================================================
void CTitle::Uninit(){
	CScene::Uninit();
}

//================================================================================================================================================================
//更新処理
//================================================================================================================================================================
void CTitle::Update(){

	//弾生成
	if (CScene::GetFadeTime() >= CScene::GetFadeMaxTime()){
		CManager::GetInstance()->SetMode(MODE_TUTORIAL);}

	CScene::Update();
}

//================================================================================================================================================================
//描画処理
//================================================================================================================================================================
void CTitle::Draw()
{
	CScene::Draw();
}

//********************************************ストーリー管理クラス****************************************************************

//================================================================================================================================================================
//コンストラクタ
//================================================================================================================================================================
CTutorial::CTutorial()
{

}

//================================================================================================================================================================
//デストラクタ
//================================================================================================================================================================
CTutorial::~CTutorial()
{

}

//================================================================================================================================================================
//初期設定
//================================================================================================================================================================
HRESULT CTutorial::Init(){

	CScene::Init();
	CPlayer_Tutorial::Create();
	CEnemy_Boss::Create(true);
	CIcon_Life::Create({ 40.f,620.f });
	CIcon_Heat::Create({ 40.f,680.f });
	CField::Create("data\\TEXTURE\\floor_tutorial.png");
	CControl_GuideTex::Create({640.f,360.f});
	CButton_Guide::Create({ 200.f,50.f });

	CManager::GetInstance()->GetSound()->PlaySoundA(CSound::TUTORIAL_BGM);

	return S_OK;
}

//================================================================================================================================================================
//終了処理
//================================================================================================================================================================
void CTutorial::Uninit()
{
	CScene::Uninit();
}

//================================================================================================================================================================
//更新処理
//================================================================================================================================================================
void CTutorial::Update()
{
	//パッド入力情報
	CInputJoypad* pJoy = CManager::GetInstance()->GetPad();

	if (pJoy->GetTrigger(CInputJoypad::JOYKEY_START)) {
		FadeTrigger();
	}

	//弾生成
	if (CScene::GetFadeTime() >= CScene::GetFadeMaxTime()){
		CManager::GetInstance()->SetMode(MODE_GAME);
	}

	CScene::Update();
}

//================================================================================================================================================================
//描画処理
//================================================================================================================================================================
void CTutorial::Draw()
{
	CScene::Draw();
}

//********************************************ゲーム管理クラス****************************************************************

//================================================================================================================================================================
//コンストラクタ
//================================================================================================================================================================
CGame::CGame()
{

}

//================================================================================================================================================================
//デストラクタ
//================================================================================================================================================================
CGame::~CGame()
{

}

//================================================================================================================================================================
//初期設定
//================================================================================================================================================================
HRESULT CGame::Init(){

	CScene::Init();
	CField::Create("data\\TEXTURE\\floor.png");
	CPlayer_Game::Create();
	CEnemy_Boss::Create(false);
	CSky::Create();
	CIcon_Life::Create({ 40.f,620.f });
	CIcon_Heat::Create({ 40.f,680.f });
	
	CManager::GetInstance()->GetSound()->PlaySoundA(CSound::BATTLE_BGM);

	return S_OK;
}


//================================================================================================================================================================
//終了処理
//================================================================================================================================================================
void CGame::Uninit()
{
	CScene::Uninit();
}

//================================================================================================================================================================
//更新処理
//================================================================================================================================================================
void CGame::Update()
{
	if (CScene::GetFadeTime() >= CScene::GetFadeMaxTime()){
		CManager::GetInstance()->SetMode(MODE_RESULT);
	}

	CScene::Update();
}

//================================================================================================================================================================
//描画処理
//================================================================================================================================================================
void CGame::Draw()
{
	CScene::Draw();
}

//********************************************リザルト管理クラス****************************************************************

//================================================================================================================================================================
//コンストラクタ
//================================================================================================================================================================
CResult::CResult()
{

}

//================================================================================================================================================================
//デストラクタ
//================================================================================================================================================================
CResult::~CResult()
{

}

//================================================================================================================================================================
//初期設定
//================================================================================================================================================================
HRESULT CResult::Init()
{
	CScene::Init();

	CField::Create("data\\TEXTURE\\floor.png");

	const bool bDidWin = CScene::GetDidWinResult();

	if (bDidWin){
		WinResult();
	}

	else {
		LoseResult();
	}


	return S_OK;
}

//================================================================================================================================================================
//勝利データ読み込み
//================================================================================================================================================================
void CResult::WinResult() {
	CPlayer_Title::Create();
}

//================================================================================================================================================================
//敗北データ読み込み
//================================================================================================================================================================
void CResult::LoseResult() {

}

//================================================================================================================================================================
//終了処理
//================================================================================================================================================================
void CResult::Uninit()
{
	CScene::Uninit();
}

//================================================================================================================================================================
//更新処理
//================================================================================================================================================================
void CResult::Update()
{
	//パッド入力情報
	CInputJoypad* pJoy = CManager::GetInstance()->GetPad();

	if (pJoy->GetTrigger(CInputJoypad::JOYKEY_START)) {
		FadeTrigger();
	}

	//弾生成
	if (CScene::GetFadeTime() >= CScene::GetFadeMaxTime()){
		CManager::GetInstance()->SetMode(MODE_TITLE);
	}

	CScene::Update();
}

//================================================================================================================================================================
//描画処理
//================================================================================================================================================================
void CResult::Draw()
{
	CScene::Draw();
}

//================================================================================================================================================================
//フェード呼ぶ処理
//================================================================================================================================================================
void CScene::FadeFlag(bool Flag){
	m_bPushFade = Flag;
}

//================================================================================================================================================================
//Object3D生成
//================================================================================================================================================================
CScene* CScene::Create(MODE mode)
{
	CScene* pScene = nullptr;

	if (mode == CScene::MODE_TITLE)
	{
		pScene = new CTitle();
	}

	else if (mode == CScene::MODE_TUTORIAL)
	{
		pScene = new CTutorial;
	}

	else if (mode == CScene::MODE_GAME)
	{
		pScene = new CGame();
	}

	else if (mode == CScene::MODE_RESULT)
	{
		pScene = new CResult();
	}

	pScene->Init();
	
	pScene->m_Mode = mode;

	return pScene;
}

//================================================================================================================================================================
//現在のフェードのモード状態を返す
//================================================================================================================================================================
bool CScene::GatFadeMode()
{
	return m_bPushFade;
}